<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Advisor</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #F7FAFC;
            color: #2D3748;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 60px;
        }
        
        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #1A202C;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1rem;
            color: #718096;
        }
        
        .upload-area {
            border: 2px dashed #CBD5E0;
            border-radius: 8px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
            margin-bottom: 40px;
        }
        
        .upload-area:hover {
            border-color: #4A5568;
            background: #F7FAFC;
        }
        
        .upload-area h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #2D3748;
            margin-bottom: 10px;
        }
        
        .upload-area p {
            color: #718096;
            font-size: 0.875rem;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .btn {
            background: #2D3748;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            margin: 10px 5px;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #1A202C;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: white;
            color: #2D3748;
            border: 1px solid #E2E8F0;
        }
        
        .btn-secondary:hover {
            background: #F7FAFC;
        }
        
        .hidden {
            display: none !important;
        }
        
        .spinner {
            border: 3px solid #E2E8F0;
            border-top: 3px solid #2D3748;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 0.8s linear infinite;
            margin: 40px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }
        
        .metric-card {
            background: white;
            padding: 24px;
            border-radius: 8px;
            border: 1px solid #E2E8F0;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #2D3748;
        }
        
        .metric-label {
            font-size: 0.875rem;
            color: #718096;
            margin-top: 8px;
        }
        
        .section {
            background: white;
            padding: 32px;
            border-radius: 8px;
            border: 1px solid #E2E8F0;
            margin: 20px 0;
        }
        
        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1A202C;
            margin-bottom: 20px;
        }
        
        .section-description {
            color: #718096;
            margin-bottom: 20px;
            font-size: 0.875rem;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }
        
        .chart {
            background: #F7FAFC;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #E2E8F0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #E2E8F0;
            font-size: 0.875rem;
        }
        
        th {
            background: #F7FAFC;
            font-weight: 600;
            color: #2D3748;
        }
        
        tr:hover {
            background: #F7FAFC;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2D3748;
            font-size: 0.875rem;
        }
        
        select, input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #E2E8F0;
            border-radius: 6px;
            font-size: 0.875rem;
            background: white;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #4A5568;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }
        
        .result-box {
            background: #F7FAFC;
            padding: 24px;
            border-radius: 8px;
            border: 1px solid #E2E8F0;
            margin-top: 20px;
        }
        
        .result-box h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: #2D3748;
            margin-bottom: 16px;
        }
        
        .result-box pre {
            white-space: pre-wrap;
            line-height: 1.6;
            color: #4A5568;
            font-size: 0.875rem;
        }
        
        .badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 12px;
        }
        
        .badge-success {
            background: #C6F6D5;
            color: #22543D;
        }
        
        .badge-error {
            background: #FED7D7;
            color: #742A2A;
        }
        
        .badge-info {
            background: #BEE3F8;
            color: #2C5282;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 16px;
        }
        
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            h1 {
                font-size: 2rem;
            }
            .button-group {
                flex-direction: column;
            }
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Data Advisor</h1>
            <p class="subtitle">Professionele data-analyse met AI insights</p>
        </header>
        
        <!-- Upload -->
        <div id="uploadArea" class="upload-area">
            <h2>Upload je dataset</h2>
            <p>Sleep een bestand of klik om te selecteren</p>
            <button class="btn" onclick="document.getElementById('fileInput').click()" style="margin-top: 20px;">
                Selecteer bestand
            </button>
            <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
            <p style="margin-top: 16px; color: #A0AEC0; font-size: 0.75rem;">
                Ondersteund: CSV, XLSX, XLS
            </p>
        </div>
        
        <!-- Loading -->
        <div id="loading" class="hidden">
            <div class="spinner"></div>
            <p style="text-align: center; color: #718096;">Bezig met laden...</p>
        </div>
        
        <!-- Results -->
        <div id="results" class="hidden">
            <!-- Metrics -->
            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-value" id="metricRows">-</div>
                    <div class="metric-label">Rijen</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metricColumns">-</div>
                    <div class="metric-label">Kolommen</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="metricMissing">-</div>
                    <div class="metric-label">Missing values</div>
                </div>
            </div>

            <!-- Data Preview -->
            <div class="section">
                <h2>Data preview</h2>
                <div id="dataPreview" style="overflow-x: auto;"></div>
            </div>

            <!-- Statistics -->
            <div class="section">
                <h2>Statistieken</h2>
                <div id="statistics"></div>
            </div>
            
            <!-- AI Insights -->
            <div class="section">
                <h2>AI Analyse</h2>
                <p class="section-description">
                    Laat AI de dataset analyseren voor inzichten en aanbevelingen
                </p>
                <button class="btn" onclick="generateInsights()">
                    Genereer analyse
                </button>
                <div id="insightsResults" class="hidden"></div>
            </div>
            
            
            <!-- PDF Export -->
            <div class="section">
                <h2>PDF Rapport</h2>
                <p class="section-description">
                    Download een compleet rapport met alle analyses
                </p>
                <div class="button-group">
                    <button class="btn" onclick="downloadPDF()">
                        Download rapport
                    </button>
                </div>
                <div id="pdfStatus" class="hidden"></div>
            </div>
            
            <!-- Machine Learning -->
            <div class="section">
                <h2>Machine Learning</h2>
                <p class="section-description">
                    Train een predictief model op je data
                </p>
                <div class="settings-grid">
                    <div class="form-group">
                        <label>Target kolom</label>
                        <select id="targetColumn">
                            <option value="">Selecteer kolom</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Model type</label>
                        <select id="modelType">
                            <option value="regression">Regression</option>
                            <option value="classification">Classification</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Test size (%)</label>
                        <input type="number" id="testSize" value="20" min="10" max="50">
                    </div>
                </div>
                <button class="btn" onclick="trainModel()">Train model</button>
                <div id="modelResults" class="hidden"></div>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://localhost:8000';
        let currentFile = null;
        let currentData = null;
        
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) handleFile(file);
        });
        
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#4A5568';
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.borderColor = '#CBD5E0';
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.borderColor = '#CBD5E0';
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });
        
        async function handleFile(file) {
            currentFile = file;
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('results').classList.add('hidden');
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('Upload failed');
                
                currentData = await response.json();
                displayResults(currentData);
                
            } catch (error) {
                alert('Error: ' + error.message);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }
        
        function displayResults(data) {
            document.getElementById('results').classList.remove('hidden');
            
            document.getElementById('metricRows').textContent = data.rows.toLocaleString();
            document.getElementById('metricColumns').textContent = data.columns;
            document.getElementById('metricMissing').textContent = data.missing_total || 0;
            
            // Data Preview
            const previewDiv = document.getElementById('dataPreview');
            if (data.preview && data.preview.length > 0) {
                let html = '<table><thead><tr>';
                Object.keys(data.preview[0]).forEach(col => {
                    html += `<th>${col}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                data.preview.slice(0, 10).forEach(row => {
                    html += '<tr>';
                    Object.values(row).forEach(val => {
                        html += `<td>${val || '-'}</td>`;
                    });
                    html += '</tr>';
                });
                html += '</tbody></table>';
                previewDiv.innerHTML = html;
            }
            
            // Statistics
            const statsDiv = document.getElementById('statistics');
            if (data.numeric_stats) {
                let html = '<table><thead><tr><th>Kolom</th><th>Mean</th><th>Median</th><th>Std</th><th>Min</th><th>Max</th></tr></thead><tbody>';
                
                for (const [col, stats] of Object.entries(data.numeric_stats)) {
                    html += `<tr>
                        <td><strong>${col}</strong></td>
                        <td>${stats.mean?.toFixed(2) || '-'}</td>
                        <td>${stats.median?.toFixed(2) || '-'}</td>
                        <td>${stats.std?.toFixed(2) || '-'}</td>
                        <td>${stats.min?.toFixed(2) || '-'}</td>
                        <td>${stats.max?.toFixed(2) || '-'}</td>
                    </tr>`;
                }
                html += '</tbody></table>';
                statsDiv.innerHTML = html;
            }
            
            // Target Column
            const targetSelect = document.getElementById('targetColumn');
            if (data.numeric_stats) {
                targetSelect.innerHTML = '<option value="">Selecteer kolom</option>';
                Object.keys(data.numeric_stats).forEach(col => {
                    targetSelect.innerHTML += `<option value="${col}">${col}</option>`;
                });
            }
        }
        
        async function generateInsights() {
            if (!currentFile) {
                alert('Upload eerst een bestand');
                return;
            }
            
            const insightsDiv = document.getElementById('insightsResults');
            insightsDiv.innerHTML = '<div class="spinner"></div><p style="text-align:center;color:#718096;">AI analyseert data...</p>';
            insightsDiv.classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('file', currentFile);
            
            try {
                const response = await fetch(`${API_URL}/insights`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Insights failed');
                }
                
                const result = await response.json();
                
                let html = `
                    <div class="result-box">
                        <h3>AI Analyse (${result.model})</h3>
                        <pre>${result.insights}</pre>
                        <div class="badge badge-info">
                            Geanalyseerd: ${result.rows_analyzed} rijen | Tokens: ${result.tokens_used || 'N/A'}
                        </div>
                    </div>
                `;
                
                insightsDiv.innerHTML = html;
                
            } catch (error) {
                insightsDiv.innerHTML = `
                    <div class="result-box">
                        <h3>Error</h3>
                        <p style="color:#718096;">${error.message}</p>
                        <div class="badge badge-error">
                            Check of GROQ_API_KEY correct is ingesteld
                        </div>
                    </div>
                `;
            }
        }
        
        async function generateDashboard() {
            if (!currentFile) {
                alert('Upload eerst een bestand');
                return;
            }
            
            const resultsDiv = document.getElementById('dashboardResults');
            resultsDiv.innerHTML = '<div class="spinner"></div>';
            resultsDiv.classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('file', currentFile);
            
            try {
                const response = await fetch(`${API_URL}/dashboard`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('Dashboard failed');
                
                const result = await response.json();
                
                // Metrics
                const metricsDiv = document.getElementById('dashboardMetrics');
                let html = '<div class="metrics">';
                for (const [key, value] of Object.entries(result.metrics)) {
                    const label = key.replace(/_/g, ' ');
                    html += `
                        <div class="metric-card">
                            <div class="metric-value">${value}</div>
                            <div class="metric-label">${label}</div>
                        </div>
                    `;
                }
                html += '</div>';
                metricsDiv.innerHTML = html;
                
                // Charts
                const chartsDiv = document.getElementById('dashboardCharts');
                chartsDiv.innerHTML = '';
                
                result.charts.forEach((chart, index) => {
                    const chartDiv = document.createElement('div');
                    chartDiv.id = `chart${index}`;
                    chartDiv.className = 'chart';
                    chartsDiv.appendChild(chartDiv);
                    
                    Plotly.newPlot(chartDiv.id, chart.data, {
                        title: chart.title,
                        height: 400,
                        ...chart.layout
                    }, {responsive: true});
                });
                
            } catch (error) {
                resultsDiv.innerHTML = `<p style="color:#E53E3E;padding:30px;text-align:center;">Error: ${error.message}</p>`;
            }
        }
        
        async function downloadPDF() {
            if (!currentFile) {
                alert('Upload eerst een bestand');
                return;
            }
            
            const statusDiv = document.getElementById('pdfStatus');
            statusDiv.innerHTML = '<div class="spinner"></div><p style="text-align:center;color:#718096;">PDF wordt gegenereerd...</p>';
            statusDiv.classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('file', currentFile);
            
            try {
                const response = await fetch(`${API_URL}/generate-pdf`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('PDF generatie mislukt');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `report_${Date.now()}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                statusDiv.innerHTML = `
                    <div class="result-box">
                        <h3>PDF Succesvol Gegenereerd</h3>
                        <p style="color:#718096;">Het rapport is gedownload</p>
                        <div class="badge badge-success">
                            Download compleet
                        </div>
                    </div>
                `;
                
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="result-box">
                        <h3>Error</h3>
                        <p style="color:#718096;">${error.message}</p>
                        <div class="badge badge-error">
                            Controleer of de backend draait
                        </div>
                    </div>
                `;
            }
        }
        
        async function trainModel() {
            const target = document.getElementById('targetColumn').value;
            const modelType = document.getElementById('modelType').value;
            const testSize = parseInt(document.getElementById('testSize').value) / 100;
            
            if (!target) {
                alert('Selecteer een target kolom');
                return;
            }
            
            const modelDiv = document.getElementById('modelResults');
            modelDiv.innerHTML = '<div class="spinner"></div>';
            modelDiv.classList.remove('hidden');
            
            const formData = new FormData();
            formData.append('file', currentFile);
            formData.append('target', target);
            formData.append('model_type', modelType);
            formData.append('test_size', testSize);
            
            try {
                const response = await fetch(`${API_URL}/train`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) throw new Error('Training failed');
                
                const result = await response.json();
                
                let html = `
                    <div class="result-box">
                        <h3>${result.model}</h3>
                        <h4 style="margin-top:16px;color:#2D3748;font-size:1rem;">Metrics:</h4>
                        <ul style="margin:10px 0;">`;
                
                for (const [key, value] of Object.entries(result.metrics)) {
                    html += `<li style="color:#4A5568;"><strong>${key}:</strong> ${value.toFixed(4)}</li>`;
                }
                
                html += `</ul>
                        <div class="badge badge-success">
                            Model succesvol getraind
                        </div>
                    </div>
                `;
                
                modelDiv.innerHTML = html;
                
            } catch (error) {
                modelDiv.innerHTML = `
                    <div class="result-box">
                        <h3>Training Error</h3>
                        <p style="color:#718096;">${error.message}</p>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>